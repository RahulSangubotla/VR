<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VR Kahoot - Fixed Grounding</title>
  
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <script>window.ioGame = window.io;</script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>

  <script src="https://unpkg.com/easyrtc@1.1.0/api/easyrtc.js"></script>
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>
</head>

<body>
  <a-scene networked-scene="room: kahoot-vr-room; adapter: wseasyrtc;">
    
    <a-assets>
      <a-asset-item id="robot-model" src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@master/examples/models/gltf/RobotExpressive/RobotExpressive.glb"></a-asset-item>

      <template id="avatar-template">
        <a-entity class="avatar" sync-name>
          <a-entity class="visuals">
              <a-entity class="model"
                        gltf-model="#robot-model" 
                        scale="0.3 0.3 0.3" 
                        rotation="0 180 0"
                        position="0 -1.6 0"
                        animation-mixer="clip: Idle; crossFadeDuration: 0.4">
              </a-entity>
              <a-text class="nametag" value="Player" align="center" position="0 0.8 0" rotation="0 180 0" scale="0.5 0.5 0.5" color="yellow" side="double"></a-text>
          </a-entity>
        </a-entity>
      </template>
    </a-assets>

    <a-sky color="#FFFFFF"></a-sky>
    <a-entity light="type: ambient; color: #BBB; intensity: 0.7"></a-entity>
    <a-entity light="type: point; color: #FFF; intensity: 0.4" position="0 4 0"></a-entity>
    
    <a-plane position="0 0 0" rotation="-90 0 0" width="15" height="15" color="#050505" material="roughness: 0.4; metalness: 0.2"></a-plane>
    <a-plane position="0 5 -7.5" width="15" height="15" color="#FFFFFF"></a-plane>
    <a-plane position="-7.5 5 0" rotation="0 90 0" width="15" height="15" color="#FFFFFF"></a-plane>
    <a-plane position="7.5 5 0" rotation="0 -90 0" width="15" height="15" color="#FFFFFF"></a-plane>
    <a-plane position="0 5 7.5" rotation="0 180 0" width="15" height="15" color="#FFFFFF"></a-plane>

    <a-entity position="0 4 -7.4">
        <a-box width="9.2" height="5.2" depth="0.1" color="#222"></a-box>
        <a-plane position="0 0 0.06" width="9" height="5" color="#000"></a-plane>
        <a-box id="timer-bar" position="0 2.3 0.1" width="9" height="0.2" depth="0.01" color="#00ff00"></a-box>
        <a-entity id="screen-text" text="value: Waiting for Host...; align: center; width: 8; color: white" position="0 0.5 0.1"></a-entity>
    </a-entity>

    <a-entity id="local-player" 
              wasd-controls 
              wall-collider="width: 15; length: 15"
              position="0 1.6 0">
        
        <a-entity camera look-controls>
            <a-entity cursor="fuse: false"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.01"
                      material="color: #3BB143; shader: flat">
            </a-entity>
        </a-entity>
    </a-entity>

    <a-entity id="my-avatar"
              networked="template:#avatar-template; attachTemplateToLocal:false;"
              avatar-sync>
    </a-entity>

  </a-scene>

  <script>
    // FIX: Wall Collider
    AFRAME.registerComponent('wall-collider', {
      schema: {
        width: {default: 15},
        length: {default: 15},
        padding: {default: 0.4}
      },
      tick: function () {
        const pos = this.el.object3D.position;
        const halfWidth = (this.data.width / 2) - this.data.padding;
        const halfLength = (this.data.length / 2) - this.data.padding;

        if (pos.x < -halfWidth) pos.x = -halfWidth;
        if (pos.x > halfWidth) pos.x = halfWidth;
        if (pos.z < -halfLength) pos.z = -halfLength;
        if (pos.z > halfLength) pos.z = halfLength;
      }
    });

    // CRITICAL FIX: Avatar Sync
    // This makes the networked avatar follow the player's position
    // BUT ignores the X-axis rotation (Pitch), keeping feet on the ground.
    AFRAME.registerComponent('avatar-sync', {
      tick: function () {
        // Only sync if this is MY avatar
        if (!NAF.utils.isMine(this.el)) return;

        const playerRig = document.querySelector("#local-player");
        const playerCamera = document.querySelector("[camera]");

        if (playerRig && playerCamera) {
            // 1. Copy Position exactly
            this.el.object3D.position.copy(playerRig.object3D.position);

            // 2. Copy Y-Rotation (Yaw) from Camera so avatar faces where you look
            // We ignore X and Z rotation so it never tilts up/down
            const camRotation = playerCamera.object3D.rotation;
            this.el.object3D.rotation.set(0, camRotation.y, 0);
        }
      }
    });

    // Random Spawn Logic
    const rig = document.querySelector('#local-player');
    const x = (Math.random() * 10) - 5;
    const z = (Math.random() * 10) - 5;
    rig.setAttribute('position', `${x} 1.6 ${z}`);
  </script>
</body>
</html>