<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VR Kahoot - Fixed Grounding</title>
  
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <script>window.ioGame = window.io;</script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
  <script src="https://unpkg.com/easyrtc@1.1.0/api/easyrtc.js"></script>
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>
</head>

<body>
  <a-scene networked-scene="room: kahoot-vr-room; adapter: wseasyrtc;">
    
    <a-assets>
      <a-asset-item id="robot-model" src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@master/examples/models/gltf/RobotExpressive/RobotExpressive.glb"></a-asset-item>

      <template id="avatar-template">
        <a-entity class="avatar" sync-name>
          <a-entity class="visuals">
              <a-entity class="model"
                        gltf-model="#robot-model" 
                        scale="0.3 0.3 0.3" 
                        rotation="0 180 0"
                        position="0 -1.6 0"
                        animation-mixer="clip: Idle; crossFadeDuration: 0.4">
              </a-entity>
              <a-text class="nametag" value="Player" align="center" position="0 0.8 0" rotation="0 180 0" scale="0.5 0.5 0.5" color="yellow" side="double"></a-text>
          </a-entity>
        </a-entity>
      </template>
    </a-assets>

    <a-sky color="#FFFFFF"></a-sky>
    <a-entity light="type: ambient; color: #BBB; intensity: 0.7"></a-entity>
    <a-entity light="type: point; color: #FFF; intensity: 0.4" position="0 4 0"></a-entity>
    
    <a-plane position="0 0 0" rotation="-90 0 0" width="15" height="15" color="#050505" material="roughness: 0.4; metalness: 0.2"></a-plane>
    <a-plane position="0 5 -7.5" width="15" height="15" color="#FFFFFF"></a-plane>
    <a-plane position="-7.5 5 0" rotation="0 90 0" width="15" height="15" color="#FFFFFF"></a-plane>
    <a-plane position="7.5 5 0" rotation="0 -90 0" width="15" height="15" color="#FFFFFF"></a-plane>
    <a-plane position="0 5 7.5" rotation="0 180 0" width="15" height="15" color="#FFFFFF"></a-plane>

    <a-entity position="0 4 -7.4">
        <a-box width="9.2" height="5.2" depth="0.1" color="#222"></a-box>
        <a-plane position="0 0 0.06" width="9" height="5" color="#000"></a-plane>
        <a-box id="timer-bar" position="0 2.3 0.1" width="9" height="0.2" depth="0.01" color="#00ff00"></a-box>
        <a-entity id="screen-text" text="value: Waiting for Host...; align: center; width: 8; color: white" position="0 0.5 0.1"></a-entity>
    </a-entity>

    <a-entity id="answer-buttons" position="0 1.5 -3" visible="false">
        <a-box position="-1.5 0 0" color="#e74c3c" class="clickable" depth="0.2" height="0.5" width="0.8"><a-text value="A" align="center" z-offset="0.11"></a-text></a-box>
        <a-box position="-0.5 0 0" color="#3498db" class="clickable" depth="0.2" height="0.5" width="0.8"><a-text value="B" align="center" z-offset="0.11"></a-text></a-box>
        <a-box position="0.5 0 0" color="#f1c40f" class="clickable" depth="0.2" height="0.5" width="0.8"><a-text value="C" align="center" color="black" z-offset="0.11"></a-text></a-box>
        <a-box position="1.5 0 0" color="#2ecc71" class="clickable" depth="0.2" height="0.5" width="0.8"><a-text value="D" align="center" z-offset="0.11"></a-text></a-box>
    </a-entity>

    <a-entity id="local-rig" 
              wasd-controls 
              wall-collider="width: 15; length: 15"
              position="0 1.6 2"> <a-entity id="local-camera" camera look-controls>
            <a-entity cursor="fuse: false"
                      raycaster="objects: .clickable"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.01"
                      material="color: #3BB143; shader: flat">
            </a-entity>
        </a-entity>
    </a-entity>

    <a-entity id="my-avatar"
              networked="template:#avatar-template; attachTemplateToLocal:false;"
              avatar-sync>
    </a-entity>

  </a-scene>

  <script>
    // --- COMPONENT: Wall Collider ---
    // Prevents the user from walking outside the room bounds
    AFRAME.registerComponent('wall-collider', {
      schema: {
        width: {default: 15},
        length: {default: 15},
        padding: {default: 0.4}
      },
      tick: function () {
        const pos = this.el.object3D.position;
        const halfWidth = (this.data.width / 2) - this.data.padding;
        const halfLength = (this.data.length / 2) - this.data.padding;

        if (pos.x < -halfWidth) pos.x = -halfWidth;
        if (pos.x > halfWidth) pos.x = halfWidth;
        if (pos.z < -halfLength) pos.z = -halfLength;
        if (pos.z > halfLength) pos.z = halfLength;
      }
    });

    // --- COMPONENT: Avatar Sync (CRITICAL FIX) ---
    // This script forces the networked avatar to match the player's position
    // BUT only copies the Y-axis rotation (left/right look), keeping feet flat on ground.
    AFRAME.registerComponent('avatar-sync', {
      tick: function () {
        // We only control our own avatar, not others'
        if (!NAF.utils.isMine(this.el)) return;

        const rig = document.querySelector("#local-rig");
        const cam = document.querySelector("#local-camera");

        if (rig && cam) {
            // 1. Copy Position exactly from Rig (WASD movement)
            this.el.object3D.position.copy(rig.object3D.position);

            // 2. Copy Y-Rotation from Camera (Where you are looking horizontally)
            // We deliberately set X and Z rotation to 0 to prevent tilting (floating)
            this.el.object3D.rotation.set(0, cam.object3D.rotation.y, 0);
        }
      }
    });
  </script>
</body>
</html>
