<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VR SmartEd Classroom - Video Lesson</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script>
      // Main Lesson Logic Component
      AFRAME.registerComponent("lesson-controller", {
        schema: {
          topic: { type: "string", default: "Human Heart Anatomy" },
          lessonNotes: {
            type: "string",
          },
        },

        init: function () {
          // DOM Elements
          this.videoEl = document.querySelector("#lesson-video");
          this.boardTextEl = document.querySelector("#board-text");
          this.boardTitleEl = document.querySelector("#board-title");
          this.boardVideoEntity = document.querySelector("#board-video");
          this.statusIndicatorEl = document.querySelector("#status-indicator");

          // State
          this.isPlaying = false;
          this.hasStarted = false;

          // Initial Board Setup
          this.boardTitleEl.setAttribute("value", this.data.topic);
          this.boardTextEl.setAttribute(
            "value",
            "Press SPACEBAR or Click to Start Video Lesson",
          );
          
          this.boardVideoEntity.setAttribute("visible", false);

          // Event Listeners
          this.bindEvents();
        },

        bindEvents: function () {
          window.addEventListener("keydown", (e) => {
            if (e.code === "Space") {
              this.togglePlayback();
            }
          });

          this.el.addEventListener("click", () => {
            this.togglePlayback();
          });

          this.el.addEventListener("triggerdown", () => {
            this.togglePlayback();
          });
        },

        togglePlayback: function () {
          if (this.isPlaying) {
            this.pauseLesson();
          } else {
            this.playLesson();
          }
        },

        playLesson: function () {
          this.isPlaying = true;
          
          this.videoEl.play().catch((e) =>
              console.log("Video play failed (interaction needed first):", e),
            );

          if (!this.hasStarted) {
            this.boardTextEl.setAttribute("value", this.data.lessonNotes);
            this.boardVideoEntity.setAttribute("visible", true);
            this.hasStarted = true;
          }

          this.statusIndicatorEl.setAttribute("value", "Status: Playing");
          this.statusIndicatorEl.setAttribute("color", "#0FE6FF");
        },

        pauseLesson: function () {
          this.isPlaying = false;
          this.videoEl.pause();
          this.statusIndicatorEl.setAttribute("value", "Status: Paused");
          this.statusIndicatorEl.setAttribute("color", "#FFEB0F");
        },
      });
    </script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <a-asset-item
          id="classroom-model"
          src="scene_no_object.gltf"
        ></a-asset-item>

        <video 
            id="lesson-video" 
            src="HeartAnatomy.mp4" 
            preload="auto" 
            crossorigin="anonymous"
            playsinline 
            webkit-playsinline>
        </video>
      </a-assets>

      <a-entity light="type: ambient; color: #FFF; intensity: 0.7"></a-entity>
      <a-entity
        light="type: directional; color: #FFF; intensity: 0.6; castShadow: true"
        position="-1 2 1"
      ></a-entity>

      <a-sky color="#ECECEC"></a-sky>

      <a-entity
        gltf-model="#classroom-model"
        position="0 0 0"
        scale="1 1 1"
      ></a-entity>

      <a-entity position="0 1.6 4.7" rotation="0 180 0">
        
        <a-plane
          width="3.5"
          height="1.2"
          color="#1a1a1a"
          material="shader: flat"
        ></a-plane>

        <a-text
          id="board-title"
          value="Lesson Title"
          position="1.01 0.4 0.01"
          align="center"
          width="3"
          color="white"
        >
        </a-text>

        <a-video
          id="board-video"
          src="#lesson-video"
          width="1.6"
          height="0.9"
          position="-0.8 0 0.02"
          visible="false"
        >
        </a-video>

        <a-text
          id="board-text"
          value="Loading lesson..."
          position="0.2 0 0.02"
          align="left"
          anchor="left"
          width="1.8"
          wrap-count="30"
          color="white"
        >
        </a-text>

        <a-text
          id="status-indicator"
          value="Status: Ready"
          position="1.5 -0.4 0.02"
          align="right"
          width="2"
          color="#4FFF0F"
        >
        </a-text>
      </a-entity>

      <a-entity id="rig" position="0 0 0" rotation="0 180 0" lesson-controller>
        <a-entity camera look-controls wasd-controls position="0 1.6 0">
          <a-entity
            cursor="fuse: false; rayOrigin: mouse;"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: black; shader: flat"
            visible="false"
          >
          </a-entity>
        </a-entity>

        <a-entity
          laser-controls="hand: right"
          raycaster="objects: .clickable; far: 5"
        ></a-entity>
        <a-entity
          laser-controls="hand: left"
          raycaster="objects: .clickable; far: 5"
        ></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>